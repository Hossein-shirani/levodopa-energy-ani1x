import torch
import torchani
from ase import Atoms
from ase.constraints import FixInternals
from ase.optimize import BFGS

# Load ANI-1x model
model = torchani.models.ANI1x(periodic_table_index=True)

# Define molecule
atoms = Atoms(
    'CCCCCCHHHOHOHCHCHCCCCHCHCHHOH',
    positions=[
        [-3.94096600, -1.12879600, 0.20347400],
        [-2.56061700, -1.32019800, 0.14023800],
        [-1.71477300, -0.23369100, -0.07406900],
        [-2.26407500, 1.04431200, -0.24666100],
        [-3.64111300, 1.21884100, -0.18142200],
        [-4.49208500, 0.13737100, 0.04679000],
        [-2.16336500, -2.32231400, 0.27262700],
        [-1.62043700, 1.89533300, -0.46020600],
        [-5.56536800, 0.30623400, 0.08666100],
        [-4.71049000, -2.22922600, 0.42316500],
        [-5.63815500, -1.96257800, 0.44427100],
        [-4.23006400, 2.43547800, -0.34562400],
        [-3.54157200, 3.09456600, -0.49957000],
        [-0.26026900, -0.47111800, -0.11398200],
        [0.03062100, -1.50930900, -0.27245000],
        [0.68875500, 0.45504300, 0.06727900],
        [0.38867600, 1.47755500, 0.30003300],
        [2.14257400, 0.22989000, 0.02352400],
        [3.00345300, 1.18570700, 0.56864300],
        [2.71996600, -0.91268300, -0.55027700],
        [4.38222300, 1.00948900, 0.56762500],
        [2.58529000, 2.08695900, 1.01295500],
        [4.09085400, -1.10321000, -0.55887900],
        [2.08396900, -1.66197700, -1.01495300],
        [4.93039900, -0.14077200, 0.00546800],
        [5.03086100, 1.76796000, 1.00339300],
        [4.53551700, -1.98670100, -1.00709300],
        [6.27015400, -0.37729000, -0.03216100],
        [6.73121600, 0.36147000, 0.38477300]
    ],
    calculator=model.ase()
)

# Set angle constraint
angle = [13, 15, 17]
angle_value = atoms.get_angle(*angle)
atoms.set_angle(*angle, 126)
constraint = FixInternals(angles_deg=[[angle_value, angle]])
atoms.set_constraint(constraint)

# Optimize geometry
optimizer = BFGS(atoms)
optimizer.run(fmax=0.00001)
